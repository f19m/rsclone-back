(()=>{"use strict";var e={n:r=>{var n=r&&r.__esModule?()=>r.default:()=>r;return e.d(n,{a:n}),n},d:(r,n)=>{for(var t in n)e.o(n,t)&&!e.o(r,t)&&Object.defineProperty(r,t,{enumerable:!0,get:n[t]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};require("core-js/modules/es.array.join.js"),require("core-js/modules/es.function.name.js"),require("core-js/modules/es.object.to-string.js"),require("core-js/modules/es.promise.js"),require("core-js/modules/web.timers.js"),require("regenerator-runtime/runtime.js");const r=require("express");var n=e.n(r);const t=require("body-parser");var a=e.n(t);require("core-js/modules/es.object.define-property.js");const o=require("argon2");var s=e.n(o);const i=require("jsonwebtoken");var u=e.n(i);require("core-js/modules/es.array.concat.js"),require("core-js/modules/es.object.keys.js"),require("core-js/modules/es.array.for-each.js");const c=require("sqlite3");var l=e.n(c);const f=require("bluebird");var p=e.n(f);function d(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var v=function(){function e(r){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.db=new(l().Database)(r,(function(e){}))}var r,n,t;return r=e,(n=[{key:"run",value:function(e){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new(p())((function(t,a){r.db.run(e,n,(function(e){e?a(e):t({id:this.lastID})}))}))}},{key:"get",value:function(e){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new(p())((function(t,a){r.db.get(e,n,(function(e,r){e?a(e):t(r)}))}))}},{key:"all",value:function(e){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new(p())((function(t,a){r.db.all(e,n,(function(e,r){e?a(e):t(r)}))}))}}])&&d(r.prototype,n),t&&d(r,t),e}();new v("db.sqlite");function m(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}function E(e){return function(){var r=this,n=arguments;return new Promise((function(t,a){var o=e.apply(r,n);function s(e){m(o,t,a,s,i,"next",e)}function i(e){m(o,t,a,s,i,"throw",e)}s(void 0)}))}}function h(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var w=new(function(){function e(r){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.dao=r}var r,n,t,a;return r=e,(n=[{key:"createTables",value:(a=E(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=4,this.dao.run("CREATE TABLE users(\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        name text,\n        email text UNIQUE,\n        password text,\n        CONSTRAINT email_unique UNIQUE (email)\n    )");case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0);case 9:return e.prev=9,e.next=13,this.dao.run("CREATE TABLE cat_type (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name text,\n      code text,\n      CONSTRAINT cat_code UNIQUE (code)\n    )");case 13:e.next=18;break;case 15:e.prev=15,e.t1=e.catch(9);case 18:return e.prev=18,e.next=22,this.dao.run("CREATE TABLE user_cat(\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name text,\n      user INTEGER,\n      type INTEGER,\n      plan REAL,\n      img text,\n      summ real,\n      CONSTRAINT user_cat_unique UNIQUE (user, type, name),\n      FOREIGN KEY(user) REFERENCES users(id),\n      FOREIGN KEY(type) REFERENCES cat_type(id)\n    )");case 22:e.next=27;break;case 24:e.prev=24,e.t2=e.catch(18);case 27:return e.prev=27,e.next=31,this.dao.run("CREATE TABLE tags(\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        user INTEGER,\n        name text,\n        FOREIGN KEY(user) REFERENCES users(id)\n      )");case 31:e.next=36;break;case 33:e.prev=33,e.t3=e.catch(27);case 36:return e.prev=36,e.next=40,this.dao.run("CREATE TABLE moves(\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\n        user INTEGER,\n        cat_from INTEGER,\n        cat_to INTEGER,\n        date NUMERIC,\n        value REAL,\n        FOREIGN KEY(user) REFERENCES users(id),\n        FOREIGN KEY(cat_from) REFERENCES user_cat(id),\n        FOREIGN KEY(cat_to) REFERENCES user_cat(id)\n      )");case 40:e.next=45;break;case 42:e.prev=42,e.t4=e.catch(36);case 45:return e.prev=45,e.next=49,this.dao.run("CREATE TABLE tags_arr(\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            collection INTEGER,\n            tag INTEGER,\n            FOREIGN KEY(collection) REFERENCES moves(id),\n            FOREIGN KEY(tag) REFERENCES tags(id)\n          )");case 49:e.next=54;break;case 51:e.prev=51,e.t5=e.catch(45);case 54:case"end":return e.stop()}}),e,this,[[0,6],[9,15],[18,24],[27,33],[36,42],[45,51]])}))),function(){return a.apply(this,arguments)})}])&&h(r.prototype,n),t&&h(r,t),e}())(new v("db.sqlite"));E(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,w.createTables();case 2:[["Доходы","income"],["Счета","accounts"],["Расходы","expenses"]].forEach((function(e){try{w.dao.run("INSERT INTO cat_type(name,code) VALUES (?, ?)",e)}catch(e){}}));case 3:case"end":return e.stop()}}),e)})))();const R=w;function y(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}function g(e){return function(){var r=this,n=arguments;return new Promise((function(t,a){var o=e.apply(r,n);function s(e){y(o,t,a,s,i,"next",e)}function i(e){y(o,t,a,s,i,"throw",e)}s(void 0)}))}}function b(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var x=function(){function e(r){return function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=r.name,this.email=r.email.toLowerCase(),this.password=r.password,this}var r,n,t,a,o;return r=e,n=null,t=[{key:"create",value:(o=g(regeneratorRuntime.mark((function r(n){var t;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return t=new e(n),r.prev=3,r.next=6,R.dao.run("INSERT INTO users (name,email,password) VALUES (?,?,?)",[t.name,t.email,t.password]);case 6:return r.abrupt("return",t);case 9:if(r.prev=9,r.t0=r.catch(3),19!==r.t0.errno){r.next=18;break}throw new Error('User with email "'.concat(t.email,'" has aldready exist'));case 18:throw new Error(r.t0.message);case 20:case 21:case"end":return r.stop()}}),r,null,[[3,9]])}))),function(e){return o.apply(this,arguments)})},{key:"findOne",value:(a=g(regeneratorRuntime.mark((function r(n){var t;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=2,r.next=5,R.dao.get("select name,email,password from users where email = ?",[n.email.toLowerCase()]);case 5:if(t=r.sent){r.next=8;break}throw new Error("User with email ".concat(n.email," not found"));case 8:return r.abrupt("return",new e(t));case 11:throw r.prev=11,r.t0=r.catch(2),new Error(r.t0.message);case 15:case"end":return r.stop()}}),r,null,[[2,11]])}))),function(e){return a.apply(this,arguments)})}],n&&b(r.prototype,n),t&&b(r,t),e}();function N(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}function T(e){return function(){var r=this,n=arguments;return new Promise((function(t,a){var o=e.apply(r,n);function s(e){N(o,t,a,s,i,"next",e)}function i(e){N(o,t,a,s,i,"throw",e)}s(void 0)}))}}function j(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var k=function(){function e(){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e)}var r,n,t,a,o;return r=e,n=null,t=[{key:"signUp",value:(o=T(regeneratorRuntime.mark((function e(r,n,t){var a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,s().hash(n);case 2:return a=e.sent,e.prev=3,e.next=6,x.create({password:a,email:r,name:t});case 6:return o=e.sent,e.abrupt("return",{user:{email:o.email,name:o.name}});case 10:throw e.prev=10,e.t0=e.catch(3),new Error(e.t0.message);case 14:case"end":return e.stop()}}),e,null,[[3,10]])}))),function(e,r,n){return o.apply(this,arguments)})},{key:"login",value:(a=T(regeneratorRuntime.mark((function e(r,n){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,x.findOne({email:r});case 2:if(t=e.sent){e.next=7;break}throw new Error("User not found");case 7:return e.next=9,s().verify(t.password,n);case 9:if(e.sent){e.next=12;break}throw new Error("Incorrect password");case 12:return e.abrupt("return",{user:{email:t.email,name:t.name},token:this.generateToken(t)});case 13:case"end":return e.stop()}}),e,this)}))),function(e,r){return a.apply(this,arguments)})},{key:"generateToken",value:function(e){var r={name:e.name,email:e.email};return u().sign({data:r},"MySuP3R_z3kr3t",{expiresIn:"1h"})}},{key:"exec",value:function(e,r){}}],n&&j(r.prototype,n),t&&j(r,t),e}();require("core-js/modules/es.regexp.exec.js"),require("core-js/modules/es.string.split.js");const I=require("express-jwt");const C=e.n(I)()({secret:"MySuP3R_z3kr3t",userProperty:"token",getToken:function(e){if(e.headers.authorization&&"Bearer"===e.headers.authorization.split(" ")[0])return e.headers.authorization.split(" ")[1]},algorithms:["HS256"]});require("core-js/modules/es.string.replace.js");function O(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}const A=function(){var e,r=(e=regeneratorRuntime.mark((function e(r,n,t){var a,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.header("Authorization").replace("Bearer ",""),o=u().verify(a,"MySuP3R_z3kr3t"),e.next=6,x.findOne({email:o.data.email});case 6:if(s=e.sent,r.currentUser=s,s){e.next=10;break}return e.abrupt("return",n.status(401).end("User not found"));case 10:return e.abrupt("return",t());case 11:case"end":return e.stop()}}),e)})),function(){var r=this,n=arguments;return new Promise((function(t,a){var o=e.apply(r,n);function s(e){O(o,t,a,s,i,"next",e)}function i(e){O(o,t,a,s,i,"throw",e)}s(void 0)}))});return function(e,n,t){return r.apply(this,arguments)}}();function P(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}function q(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}var U=function(){function e(){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e)}var r,n,t,a,o;return r=e,n=null,t=[{key:"getCategories",value:(a=regeneratorRuntime.mark((function e(){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=4,R.dao.all("select * from cat_type whsere id = 5");case 4:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}}),e)})),o=function(){var e=this,r=arguments;return new Promise((function(n,t){var o=a.apply(e,r);function s(e){P(o,n,t,s,i,"next",e)}function i(e){P(o,n,t,s,i,"throw",e)}s(void 0)}))},function(){return o.apply(this,arguments)})}],n&&q(r.prototype,n),t&&q(r,t),e}();function G(e,r,n,t,a,o,s){try{var i=e[o](s),u=i.value}catch(e){return void n(e)}i.done?r(u):Promise.resolve(u).then(t,a)}function S(e){return function(){var r=this,n=arguments;return new Promise((function(t,a){var o=e.apply(r,n);function s(e){G(o,t,a,s,i,"next",e)}function i(e){G(o,t,a,s,i,"throw",e)}s(void 0)}))}}var _=n()(),Y=process.env.PORT||80;_.listen(Y,(function(){}));_.get("/",(function(e,r,n){r.json({greeting:"Hello Word"})})),_.use(a().urlencoded({extended:!1})),_.use(a().json()),_.post("/api/createUser",(function(e,r,n){var t=[];e.body.password||t.push("No password specified"),e.body.email||t.push("No email specified"),t.length?r.status(400).json({error:t.join(",")}):S(regeneratorRuntime.mark((function n(){var t;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,k.signUp(e.body.email,e.body.password,e.body.name);case 3:t=n.sent,r.json(JSON.stringify(t)),n.next=11;break;case 7:n.prev=7,n.t0=n.catch(0),r.status(400).json({error:n.t0.message});case 11:case"end":return n.stop()}}),n,null,[[0,7]])})))()})),_.post("/api/login",(function(e,r,n){var t=[];e.body.email||t.push("No email specified"),e.body.password||t.push("No password specified"),t.length?r.status(400).json({error:t.join(",")}):S(regeneratorRuntime.mark((function n(){var t;return regeneratorRuntime.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,k.login(e.body.email,e.body.password);case 3:t=n.sent,r.json(JSON.stringify(t)),n.next=11;break;case 7:n.prev=7,n.t0=n.catch(0),r.status(400).json({error:n.t0.message});case 11:case"end":return n.stop()}}),n,null,[[0,7]])})))()})),_.post("/api/categories",C,A,(function(e,r){U.getCategories().then((function(e){return r.json(e).status(200)})).catch((function(e){return r.json(e.message).status(500)}))})),_.use((function(e,r,n){r.status(404).send("Sorry cant find that!")}))})();